---
- name: Gather instance facts
  setup:

- include_tasks: "setup-{{ ansible_distribution|lower }}.yml"

- name: Install WireGuard
  package:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - wireguard-dkms
      - wireguard-tools
  tags:
    - wg-install
    - skip_ansible_lint

- name: Enable WireGuard kernel module
  modprobe:
    name: wireguard
    state: present
  register: wireguard_module_enabled
  until: wireguard_module_enabled is succeeded
  retries: 10
  delay: 10
  failed_when: wireguard_module_enabled is failure
  tags:
    - wg-install

- name: Set WireGuard IP (without mask)
  set_fact:
    wireguard_ip: "{{ wireguard_address.split('/')[0] }}"

# lookup ini plugin doesn't work on remote hosts...
- name: Check if WireGuard file exists
  stat:
    path: "{{ wg_conf_path }}"
  register: wg_conf

- name: Read WireGuard private key
  shell: "cat {{ wg_conf_path }} | grep PrivateKey | cut -d= -f2- | tr -d [:space:]"
  register: wg_private_key_result
  changed_when: false
  when: wg_conf.stat.exists
  tags:
    - wg-generate-keys

- name: Set private key fact
  set_fact:
    wg_private_key: "{{ wg_private_key_result.stdout }}"
  when: wg_conf.stat.exists
  tags:
    - wg-generate-keys

- name: Generate WireGuard private key
  shell: "wg genkey"
  register: wg_private_key_result
  when: not wg_conf.stat.exists
  changed_when: false
  tags:
    - wg-generate-keys
    - skip_ansible_lint

- name: Set private key fact
  set_fact:
    wg_private_key: "{{ wg_private_key_result.stdout }}"
  when: not wg_conf.stat.exists
  tags:
    - wg-generate-keys

- name: Derive WireGuard public key
  shell: "echo '{{ wg_private_key }}' | wg pubkey"
  register: wg_public_key_result
  when: not private_key_file_stat.stat.exists
  changed_when: false
  tags:
    - wg-generate-keys

- name: Set public key fact
  set_fact:
    wg_public_key: "{{ wg_public_key_result.stdout }}"
  tags:
    - wg-generate-keys

- name: Create WireGuard configuration directory
  file:
    dest: "{{ wireguard_remote_directory }}"
    state: directory
    mode: 0700
  tags:
    - wg-config

- name: Generate WireGuard configuration file
  template:
    src: wg.conf.j2
    dest: "{{ wg_conf_path }}"
    owner: root
    group: root
    mode: 0600
  tags:
    - wg-config
  notify:
    - restart wireguard

- name: Start and enable WireGuard service
  service:
    name: "wg-quick@{{ wireguard_interface }}"
    state: started
    enabled: true
